import { DecadaireDTO } from '@/db/decadaires/DTO.js';
import { InMemoryDecadairesRepository } from '@/db/decadaires/InMemoryRepository.js';
import { getArrayFromAsyncGenerator } from '@/lib/generator/generatorUtils.js';
import { describe, expect, it } from 'vitest';

export const dto1: DecadaireDTO = {
    NUM_POSTE: '01014002',
    NOM_USUEL: 'ARBENT',
    LAT: 46.278167,
    LON: 5.669,
    ALTI: 534,
    AAAAMM: new Date('2023-01-01T00:00:00Z'),
    NUM_DECADE: 1,
    RR: 60.8,
    QRR: 1,
    NBRR: 10,
    RRAB: 17.8,
    QRRAB: 1,
    RRABDAT: 8,
    NBJRR1: 6,
    NBJRR5: 5,
    NBJRR10: 3,
    NBJRR30: 0,
    NBJRR50: 0,
    NBJRR100: 0,
    PMERM: null,
    QPMERM: null,
    NBPMERM: 0,
    PMERMINAB: null,
    QPMERMINAB: null,
    PMERMINABDAT: null,
    TX: 10.8,
    QTX: 1,
    NBTX: 10,
    TXAB: 17.7,
    QTXAB: 1,
    TXDAT: 1,
    TXMIN: 5.0,
    QTXMIN: 1,
    TXMINDAT: 9,
    NBJTX0: 0,
    NBJTX25: 0,
    NBJTX30: 0,
    NBJTX35: 0,
    NBJTXI20: 10,
    NBJTXI27: 10,
    NBJTXS32: 0,
    TN: 5.3,
    QTN: 1,
    NBTN: 10,
    TNAB: 1.0,
    QTNAB: 1,
    TNDAT: 4,
    TNMAX: 11.6,
    QTNMAX: 1,
    TNMAXDAT: 1,
    NBJTN5: 0,
    NBJTN10: 0,
    NBJTNI10: 9,
    NBJTNI15: 10,
    NBJTNI20: 10,
    NBJTNS20: 0,
    NBJTNS25: 0,
    NBJGELEE: 0,
    TAMPLIM: 5.5,
    QTAMPLIM: 1,
    TAMPLIAB: 9.0,
    QTAMPLIAB: 1,
    TAMPLIABDAT: 3,
    NBTAMPLI: 10,
    TM: 8.1,
    QTM: 1,
    NBTM: 10,
    TMM: 8.1,
    QTMM: 1,
    NBTMM: 10,
    NBJTMS24: 0,
    TMMIN: 3.3,
    QTMMIN: 1,
    TMMINDAT: 9,
    TMMAX: 14.7,
    QTMMAX: 1,
    TMMAXDAT: 1,
    UNAB: 38,
    QUNAB: 1,
    UNABDAT: 2,
    NBUN: 10,
    UXAB: 100,
    QUXAB: 1,
    UXABDAT: 6,
    NBUX: 10,
    UMM: 82,
    QUMM: 1,
    NBUM: 10,
    TSVM: 8.7,
    QTSVM: 9,
    NBTSVM: 10,
    FXIAB: 18.0,
    QFXIAB: 1,
    DXIAB: 170,
    QDXIAB: 9,
    FXIDAT: 7,
    NBJFF10: 5,
    NBJFF16: 2,
    NBJFF28: 0,
    NBFXI: 10,
    FXI3SAB: 16.1,
    QFXI3SAB: 9,
    DXI3SAB: null,
    QDXI3SAB: 0,
    FXI3SDAT: 7,
    NBJFXI3S10: 5,
    NBJFXI3S16: 1,
    NBJFXI3S28: 0,
    NBFXI3S: 10,
    FXYAB: 7.6,
    QFXYAB: 1,
    DXYAB: 180,
    QDXYAB: 9,
    FXYABDAT: 7,
    NBJFXY8: 0,
    NBJFXY10: 0,
    NBJFXY15: 0,
    NBFXY: 10,
    FFM: 2.3,
    QFFM: 1,
    NBFFM: 10,
    INST: null,
    QINST: null,
    NBINST: 0,
    NBSIGMA0: null,
    NBSIGMA20: null,
    NBSIGMA80: null,
    GLOT: null,
    QGLOT: null,
    NBGLOT: 0,
    DIFT: null,
    QDIFT: null,
    NBDIFT: 0,
    DIRT: null,
    QDIRT: null,
    NBDIRT: 0,
    HNEIGEFTOT: null,
    QHNEIGEFTOT: null,
    HNEIGEFAB: null,
    QHNEIGEFAB: null,
    HNEIGEFDAT: null,
    NBHNEIGEF: 0,
    NBJNEIG: null,
    NBJHNEIGEF1: null,
    NBJHNEIGEF5: null,
    NBJHNEIGEF10: null,
    NBJSOLNG: null,
    NEIGETOTM: 0,
    QNEIGETOTM: 9,
    NEIGETOTAB: 0,
    QNEIGETOTAB: 9,
    NEIGETOTABDAT: null,
    NBJNEIGETOT1: 0,
    NBJNEIGETOT10: 0,
    NBJNEIGETOT30: 0,
    NBJGREL: 0,
    NBJORAG: null,
    NBJBROU: null,
};

export const dto2: DecadaireDTO = {
    NUM_POSTE: '01014002',
    NOM_USUEL: 'ARBENT',
    LAT: 46.278167,
    LON: 5.669,
    ALTI: 534,
    AAAAMM: new Date('2023-01-01T00:00:00Z'),
    NUM_DECADE: 2,
    RR: 51.2,
    QRR: 1,
    NBRR: 10,
    RRAB: 11.6,
    QRRAB: 1,
    RRABDAT: 15,
    NBJRR1: 8,
    NBJRR5: 5,
    NBJRR10: 1,
    NBJRR30: 0,
    NBJRR50: 0,
    NBJRR100: 0,
    PMERM: null,
    QPMERM: null,
    NBPMERM: 0,
    PMERMINAB: null,
    QPMERMINAB: null,
    PMERMINABDAT: null,
    TX: 6.7,
    QTX: 1,
    NBTX: 10,
    TXAB: 11.6,
    QTXAB: 1,
    TXDAT: 14,
    TXMIN: 0.7,
    QTXMIN: 1,
    TXMINDAT: 18,
    NBJTX0: 0,
    NBJTX25: 0,
    NBJTX30: 0,
    NBJTX35: 0,
    NBJTXI20: 10,
    NBJTXI27: 10,
    NBJTXS32: 0,
    TN: -1.8,
    QTN: 1,
    NBTN: 10,
    TNAB: -15.7,
    QTNAB: 1,
    TNDAT: 20,
    TNMAX: 3.6,
    QTNMAX: 1,
    TNMAXDAT: 13,
    NBJTN5: 2,
    NBJTN10: 2,
    NBJTNI10: 10,
    NBJTNI15: 10,
    NBJTNI20: 10,
    NBJTNS20: 0,
    NBJTNS25: 0,
    NBJGELEE: 4,
    TAMPLIM: 8.5,
    QTAMPLIM: 1,
    TAMPLIAB: 20.2,
    QTAMPLIAB: 1,
    TAMPLIABDAT: 20,
    NBTAMPLI: 10,
    TM: 2.5,
    QTM: 1,
    NBTM: 10,
    TMM: 2.1,
    QTMM: 1,
    NBTMM: 10,
    NBJTMS24: 0,
    TMMIN: -5.6,
    QTMMIN: 1,
    TMMINDAT: 20,
    TMMAX: 6.6,
    QTMMAX: 1,
    TMMAXDAT: 13,
    UNAB: 35,
    QUNAB: 1,
    UNABDAT: 14,
    NBUN: 10,
    UXAB: 100,
    QUXAB: 1,
    UXABDAT: 20,
    NBUX: 10,
    UMM: 88,
    QUMM: 1,
    NBUM: 10,
    TSVM: 6.4,
    QTSVM: 9,
    NBTSVM: 10,
    FXIAB: 18.2,
    QFXIAB: 1,
    DXIAB: 150,
    QDXIAB: 1,
    FXIDAT: 16,
    NBJFF10: 5,
    NBJFF16: 2,
    NBJFF28: 0,
    NBFXI: 10,
    FXI3SAB: 16.7,
    QFXI3SAB: 9,
    DXI3SAB: null,
    QDXI3SAB: 0,
    FXI3SDAT: 16,
    NBJFXI3S10: 5,
    NBJFXI3S16: 1,
    NBJFXI3S28: 0,
    NBFXI3S: 10,
    FXYAB: 10.2,
    QFXYAB: 1,
    DXYAB: 150,
    QDXYAB: 1,
    FXYABDAT: 16,
    NBJFXY8: 1,
    NBJFXY10: 1,
    NBJFXY15: 0,
    NBFXY: 10,
    FFM: 1.9,
    QFFM: 1,
    NBFFM: 10,
    INST: null,
    QINST: null,
    NBINST: 0,
    NBSIGMA0: null,
    NBSIGMA20: null,
    NBSIGMA80: null,
    GLOT: null,
    QGLOT: null,
    NBGLOT: 0,
    DIFT: null,
    QDIFT: null,
    NBDIFT: 0,
    DIRT: null,
    QDIRT: null,
    NBDIRT: 0,
    HNEIGEFTOT: null,
    QHNEIGEFTOT: null,
    HNEIGEFAB: null,
    QHNEIGEFAB: null,
    HNEIGEFDAT: null,
    NBHNEIGEF: 0,
    NBJNEIG: null,
    NBJHNEIGEF1: null,
    NBJHNEIGEF5: null,
    NBJHNEIGEF10: null,
    NBJSOLNG: null,
    NEIGETOTM: 4,
    QNEIGETOTM: 9,
    NEIGETOTAB: 12,
    QNEIGETOTAB: 9,
    NEIGETOTABDAT: 19,
    NBJNEIGETOT1: 4,
    NBJNEIGETOT10: 2,
    NBJNEIGETOT30: 0,
    NBJGREL: 0,
    NBJORAG: null,
    NBJBROU: null,
};

describe('InMemoryDecadairesRepository', () => {
    describe('upsert', () => {
        it('should upsert', async () => {
            const repository = new InMemoryDecadairesRepository({ dtos: [] });

            await repository.upsert(dto1);
            await repository.upsert(dto2);
            const dtos1 = await getArrayFromAsyncGenerator(repository.getAll());
            expect(dtos1).toEqual([dto1, dto2]);

            const modifiedDto1: DecadaireDTO = {
                ...dto1,
                NBJBROU: 1,
            };

            await repository.upsert(modifiedDto1);
            const dtos2 = await getArrayFromAsyncGenerator(repository.getAll());
            expect(dtos2).toEqual([modifiedDto1, dto2]);
        });
    });
});
