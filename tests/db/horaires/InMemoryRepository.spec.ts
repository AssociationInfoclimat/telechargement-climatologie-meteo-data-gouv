import { HoraireDTO } from '@/db/horaires/DTO.js';
import { InMemoryHorairesRepository } from '@/db/horaires/InMemoryRepository.js';
import { getArrayFromAsyncGenerator } from '@/lib/generator/generatorUtils.js';
import { describe, expect, it } from 'vitest';

export const dto1: HoraireDTO = {
    NUM_POSTE: '01014002',
    NOM_USUEL: 'ARBENT',
    LAT: 46.278167,
    LON: 5.669,
    ALTI: 534,
    AAAAMMJJHH: new Date('2023-01-01T00:00:00Z'),
    RR1: 0,
    QRR1: 1,
    DRR1: null,
    QDRR1: null,
    FF: 2.6,
    QFF: 1,
    DD: 200,
    QDD: 1,
    FXY: 4.1,
    QFXY: 1,
    DXY: 170,
    QDXY: 1,
    HXY: '2313',
    QHXY: 9,
    FXI: 8.8,
    QFXI: 1,
    DXI: 160,
    QDXI: 1,
    HXI: '2317',
    QHXI: 9,
    FF2: null,
    QFF2: null,
    DD2: null,
    QDD2: null,
    FXI2: null,
    QFXI2: null,
    DXI2: null,
    QDXI2: null,
    HXI2: null,
    QHXI2: null,
    FXI3S: 7.7,
    QFXI3S: 9,
    DXI3S: null,
    QDXI3S: null,
    HFXI3S: '2317',
    QHFXI3S: 9,
    T: 12.3,
    QT: 1,
    TD: 7.6,
    QTD: 1,
    TN: 11.9,
    QTN: 1,
    HTN: '2345',
    QHTN: 9,
    TX: 12.9,
    QTX: 1,
    HTX: '2308',
    QHTX: 9,
    DG: 0,
    QDG: 9,
    T10: null,
    QT10: null,
    T20: null,
    QT20: null,
    T50: null,
    QT50: null,
    T100: null,
    QT100: null,
    TNSOL: null,
    QTNSOL: null,
    TN50: null,
    QTN50: null,
    TCHAUSSEE: null,
    QTCHAUSSEE: null,
    DHUMEC: null,
    QDHUMEC: null,
    U: 73,
    QU: 1,
    UN: 71,
    QUN: 1,
    HUN: '2312',
    QHUN: 9,
    UX: 75,
    QUX: 1,
    HUX: '2345',
    QHUX: 9,
    DHUMI40: 0,
    QDHUMI40: 9,
    DHUMI80: 0,
    QDHUMI80: 9,
    TSV: 10.4,
    QTSV: 1,
    PMER: null,
    QPMER: null,
    PSTAT: null,
    QPSTAT: null,
    PMERMIN: null,
    QPERMIN: null,
    GEOP: null,
    QGEOP: null,
    N: null,
    QN: null,
    NBAS: null,
    QNBAS: null,
    CL: null,
    QCL: null,
    CM: null,
    QCM: null,
    CH: null,
    QCH: null,
    N1: null,
    QN1: null,
    C1: null,
    QC1: null,
    B1: null,
    QB1: null,
    N2: null,
    QN2: null,
    C2: null,
    QC2: null,
    B2: null,
    QCB2: null,
    N3: null,
    QN3: null,
    C3: null,
    QC3: null,
    B3: null,
    QB3: null,
    N4: null,
    QN4: null,
    C4: null,
    QC4: null,
    B4: null,
    QB4: null,
    VV: null,
    QVV: null,
    DVV200: null,
    QDVV200: null,
    WW: null,
    QWW: null,
    W1: null,
    QW1: null,
    W2: null,
    QW2: null,
    SOL: null,
    QSOL: null,
    SOLNG: null,
    QSOLNG: null,
    TMER: null,
    QTMER: null,
    VVMER: null,
    QVVMER: null,
    ETATMER: null,
    QETATMER: null,
    DIRHOULE: null,
    QDIRHOULE: null,
    HVAGUE: null,
    QHVAGUE: null,
    PVAGUE: null,
    QPVAGUE: null,
    HNEIGEF: null,
    QHNEIGEF: null,
    NEIGETOT: 0,
    QNEIGETOT: 9,
    TSNEIGE: null,
    QTSNEIGE: null,
    TUBENEIGE: null,
    QTUBENEIGE: null,
    HNEIGEFI3: null,
    QHNEIGEFI3: null,
    HNEIGEFI1: null,
    QHNEIGEFI1: null,
    ESNEIGE: null,
    QESNEIGE: null,
    CHARGENEIGE: null,
    QCHARGENEIGE: null,
    GLO: null,
    QGLO: null,
    GLO2: null,
    QGLO2: null,
    DIR: null,
    QDIR: null,
    DIR2: null,
    QDIR2: null,
    DIF: null,
    QDIF: null,
    DIF2: null,
    QDIF2: null,
    UV: null,
    QUV: null,
    UV2: null,
    QUV2: null,
    UV_INDICE: null,
    QUV_INDICE: null,
    INFRAR: null,
    QINFRAR: null,
    INFRAR2: null,
    QINFRAR2: null,
    INS: null,
    QINS: null,
    INS2: null,
    QINS2: null,
    TLAGON: null,
    QTLAGON: null,
    TVEGETAUX: null,
    QTVEGETAUX: null,
    ECOULEMENT: null,
    QECOULEMENT: null,
};

export const dto2: HoraireDTO = {
    NUM_POSTE: '01014002',
    NOM_USUEL: 'ARBENT',
    LAT: 46.278167,
    LON: 5.669,
    ALTI: 534,
    AAAAMMJJHH: new Date('2023-01-01T01:00:00Z'),
    RR1: 0,
    QRR1: 1,
    DRR1: null,
    QDRR1: null,
    FF: 2.2,
    QFF: 1,
    DD: 170,
    QDD: 1,
    FXY: 4.0,
    QFXY: 1,
    DXY: 160,
    QDXY: 1,
    HXY: '0040',
    QHXY: 9,
    FXI: 8.3,
    QFXI: 1,
    DXI: 150,
    QDXI: 1,
    HXI: '0031',
    QHXI: 9,
    FF2: null,
    QFF2: null,
    DD2: null,
    QDD2: null,
    FXI2: null,
    QFXI2: null,
    DXI2: null,
    QDXI2: null,
    HXI2: null,
    QHXI2: null,
    FXI3S: 7.1,
    QFXI3S: 9,
    DXI3S: null,
    QDXI3S: null,
    HFXI3S: '0031',
    QHFXI3S: 9,
    T: 12.0,
    QT: 1,
    TD: 7.6,
    QTD: 1,
    TN: 12.0,
    QTN: 1,
    HTN: '0016',
    QHTN: 9,
    TX: 12.5,
    QTX: 1,
    HTX: '0041',
    QHTX: 9,
    DG: 0,
    QDG: 9,
    T10: null,
    QT10: null,
    T20: null,
    QT20: null,
    T50: null,
    QT50: null,
    T100: null,
    QT100: null,
    TNSOL: null,
    QTNSOL: null,
    TN50: null,
    QTN50: null,
    TCHAUSSEE: null,
    QTCHAUSSEE: null,
    DHUMEC: null,
    QDHUMEC: null,
    U: 74,
    QU: 1,
    UN: 73,
    QUN: 1,
    HUN: '0001',
    QHUN: 9,
    UX: 75,
    QUX: 1,
    HUX: '0027',
    QHUX: 9,
    DHUMI40: 0,
    QDHUMI40: 9,
    DHUMI80: 0,
    QDHUMI80: 9,
    TSV: 10.4,
    QTSV: 1,
    PMER: null,
    QPMER: null,
    PSTAT: null,
    QPSTAT: null,
    PMERMIN: null,
    QPERMIN: null,
    GEOP: null,
    QGEOP: null,
    N: null,
    QN: null,
    NBAS: null,
    QNBAS: null,
    CL: null,
    QCL: null,
    CM: null,
    QCM: null,
    CH: null,
    QCH: null,
    N1: null,
    QN1: null,
    C1: null,
    QC1: null,
    B1: null,
    QB1: null,
    N2: null,
    QN2: null,
    C2: null,
    QC2: null,
    B2: null,
    QCB2: null,
    N3: null,
    QN3: null,
    C3: null,
    QC3: null,
    B3: null,
    QB3: null,
    N4: null,
    QN4: null,
    C4: null,
    QC4: null,
    B4: null,
    QB4: null,
    VV: null,
    QVV: null,
    DVV200: null,
    QDVV200: null,
    WW: null,
    QWW: null,
    W1: null,
    QW1: null,
    W2: null,
    QW2: null,
    SOL: null,
    QSOL: null,
    SOLNG: null,
    QSOLNG: null,
    TMER: null,
    QTMER: null,
    VVMER: null,
    QVVMER: null,
    ETATMER: null,
    QETATMER: null,
    DIRHOULE: null,
    QDIRHOULE: null,
    HVAGUE: null,
    QHVAGUE: null,
    PVAGUE: null,
    QPVAGUE: null,
    HNEIGEF: null,
    QHNEIGEF: null,
    NEIGETOT: 0,
    QNEIGETOT: 9,
    TSNEIGE: null,
    QTSNEIGE: null,
    TUBENEIGE: null,
    QTUBENEIGE: null,
    HNEIGEFI3: null,
    QHNEIGEFI3: null,
    HNEIGEFI1: null,
    QHNEIGEFI1: null,
    ESNEIGE: null,
    QESNEIGE: null,
    CHARGENEIGE: null,
    QCHARGENEIGE: null,
    GLO: null,
    QGLO: null,
    GLO2: null,
    QGLO2: null,
    DIR: null,
    QDIR: null,
    DIR2: null,
    QDIR2: null,
    DIF: null,
    QDIF: null,
    DIF2: null,
    QDIF2: null,
    UV: null,
    QUV: null,
    UV2: null,
    QUV2: null,
    UV_INDICE: null,
    QUV_INDICE: null,
    INFRAR: null,
    QINFRAR: null,
    INFRAR2: null,
    QINFRAR2: null,
    INS: null,
    QINS: null,
    INS2: null,
    QINS2: null,
    TLAGON: null,
    QTLAGON: null,
    TVEGETAUX: null,
    QTVEGETAUX: null,
    ECOULEMENT: null,
    QECOULEMENT: null,
};

describe('InMemoryHorairesRepository', () => {
    describe('upsert', () => {
        it('should upsert', async () => {
            const repository = new InMemoryHorairesRepository({ dtos: [] });

            await repository.upsert(dto1);
            await repository.upsert(dto2);
            const dtos1 = await getArrayFromAsyncGenerator(repository.getAll());
            expect(dtos1).toEqual([dto1, dto2]);

            const modifiedDto1: HoraireDTO = {
                ...dto1,
                QECOULEMENT: 1,
            };

            await repository.upsert(modifiedDto1);
            const dtos2 = await getArrayFromAsyncGenerator(repository.getAll());
            expect(dtos2).toEqual([modifiedDto1, dto2]);
        });
    });
});
