import { InMemoryQuotidiennesRepository } from '@/db/quotidiennes/rr-t-vent/InMemoryRepository.js';
import { createInMemoryGlobber } from '@/lib/fs/glob/glob.in-memory.js';
import { createInMemoryLineReader } from '@/lib/fs/read-lines/readLines.in-memory.js';
import { getArrayFromAsyncGenerator } from '@/lib/generator/generatorUtils.js';
import { saveCSVsToDB } from '@/quotidiennes/rr-t-vent/use-cases/saveCSVsToDB.js';
import { InMemorySaveProgressRepository } from '@/save-progress/db/InMemorySaveProgressRepository.js';
import { assert, describe, it } from 'vitest';

describe('saveCSVsToDB', () => {
    it('should work', async () => {
        const quotidiennesRepository = new InMemoryQuotidiennesRepository();
        const saveProgressRepository = new InMemorySaveProgressRepository(['Q_01_1940-1949_RR-T-Vent']);
        await saveCSVsToDB({
            directory: '/my/directory',
            globber: createInMemoryGlobber([
                '/my/directory/Q_01_1940-1949_RR-T-Vent.csv',
                '/my/directory/Q_01_previous-1950-2022_RR-T-Vent.csv',
                '/my/directory/Q_01_latest-2023-2024_RR-T-Vent.csv',
            ]),
            lineReader: createInMemoryLineReader({
                '/my/directory/Q_01_1940-1949_RR-T-Vent.csv': [
                    'NUM_POSTE;NOM_USUEL;LAT;LON;ALTI;AAAAMMJJ;RR;QRR;TN;QTN;HTN;QHTN;TX;QTX;HTX;QHTX;TM;QTM;TNTXM;QTNTXM;TAMPLI;QTAMPLI;TNSOL;QTNSOL;TN50;QTN50;DG;QDG;FFM;QFFM;FF2M;QFF2M;FXY;QFXY;DXY;QDXY;HXY;QHXY;FXI;QFXI;DXI;QDXI;HXI;QHXI;FXI2;QFXI2;DXI2;QDXI2;HXI2;QHXI2;FXI3S;QFXI3S;DXI3S;QDXI3S;HXI3S;QHXI3S;DRR;QDRR',
                    '01014002;ARBENT;46.278167;5.669000;534;19400103;1.1;9;-2.2;9;1230;9;-2.2;9;1230;9;-2.2;9;-2.2;9;1.1;9;-2.2;9;-2.2;9;3;9;1.1;9;1.1;9;1.1;9;360;9;1230;9;1.1;9;360;9;1230;9;1.1;9;360;9;1230;9;1.1;9;360;9;1230;9;3;9',
                    '01014002;ARBENT;46.278167;5.669000;534;19400104;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;',
                    '',
                ],
                '/my/directory/Q_01_previous-1950-2022_RR-T-Vent.csv': [
                    'NUM_POSTE;NOM_USUEL;LAT;LON;ALTI;AAAAMMJJ;RR;QRR;TN;QTN;HTN;QHTN;TX;QTX;HTX;QHTX;TM;QTM;TNTXM;QTNTXM;TAMPLI;QTAMPLI;TNSOL;QTNSOL;TN50;QTN50;DG;QDG;FFM;QFFM;FF2M;QFF2M;FXY;QFXY;DXY;QDXY;HXY;QHXY;FXI;QFXI;DXI;QDXI;HXI;QHXI;FXI2;QFXI2;DXI2;QDXI2;HXI2;QHXI2;FXI3S;QFXI3S;DXI3S;QDXI3S;HXI3S;QHXI3S;DRR;QDRR',
                    '01014002;ARBENT;46.278167;5.669000;534;20230101;0.0;1;11.6;1;115;9;17.7;1;1123;9;14.3;1;14.7;1;6.1;1;;;;;0;9;4.8;1;;;6.8;1;160;1;947;9;14.8;1;200;9;1943;9;;;;;;;13.6;9;;;1135;9;;',
                    '01014002;ARBENT;46.278167;5.669000;534;20230102;11.0;1;8.6;1;1746;9;14.3;1;846;9;11.5;1;11.5;1;5.7;1;;;;;0;9;3.0;1;;;6.3;1;200;1;1001;9;14.4;1;180;1;954;9;;;;;;;12.0;9;;;955;9;;',
                    '',
                ],
                '/my/directory/Q_01_latest-2023-2024_RR-T-Vent.csv': [
                    'NUM_POSTE;NOM_USUEL;LAT;LON;ALTI;AAAAMMJJ;RR;QRR;TN;QTN;HTN;QHTN;TX;QTX;HTX;QHTX;TM;QTM;TNTXM;QTNTXM;TAMPLI;QTAMPLI;TNSOL;QTNSOL;TN50;QTN50;DG;QDG;FFM;QFFM;FF2M;QFF2M;FXY;QFXY;DXY;QDXY;HXY;QHXY;FXI;QFXI;DXI;QDXI;HXI;QHXI;FXI2;QFXI2;DXI2;QDXI2;HXI2;QHXI2;FXI3S;QFXI3S;DXI3S;QDXI3S;HXI3S;QHXI3S;DRR;QDRR',
                    '01014002;ARBENT;46.278167;5.669000;534;20230103;1.1;9;-2.2;9;1230;9;-2.2;9;1230;9;-2.2;9;-2.2;9;1.1;9;-2.2;9;-2.2;9;3;9;1.1;9;1.1;9;1.1;9;360;9;1230;9;1.1;9;360;9;1230;9;1.1;9;360;9;1230;9;1.1;9;360;9;1230;9;3;9',
                    '01014002;ARBENT;46.278167;5.669000;534;20230104;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;',
                    '',
                ],
            }),
            quotidiennesRepository,
            saveProgressRepository,
        });
        assert.sameDeepMembers(await saveProgressRepository.getAlreadySaved(), [
            'Q_01_1940-1949_RR-T-Vent',
            'Q_01_previous-1950-2022_RR-T-Vent',
            'Q_01_latest-2023-2024_RR-T-Vent',
        ]);
        assert.sameDeepMembers(await getArrayFromAsyncGenerator(quotidiennesRepository.getAll()), [
            {
                NUM_POSTE: '01014002',
                NOM_USUEL: 'ARBENT',
                LAT: 46.278167,
                LON: 5.669,
                ALTI: 534,
                AAAAMMJJ: new Date('2023-01-01T00:00:00Z'),
                RR: 0.0,
                QRR: 1,
                TN: 11.6,
                QTN: 1,
                HTN: '0115',
                QHTN: 9,
                TX: 17.7,
                QTX: 1,
                HTX: '1123',
                QHTX: 9,
                TM: 14.3,
                QTM: 1,
                TNTXM: 14.7,
                QTNTXM: 1,
                TAMPLI: 6.1,
                QTAMPLI: 1,
                TNSOL: null,
                QTNSOL: null,
                TN50: null,
                QTN50: null,
                DG: 0,
                QDG: 9,
                FFM: 4.8,
                QFFM: 1,
                FF2M: null,
                QFF2M: null,
                FXY: 6.8,
                QFXY: 1,
                DXY: 160,
                QDXY: 1,
                HXY: '0947',
                QHXY: 9,
                FXI: 14.8,
                QFXI: 1,
                DXI: 200,
                QDXI: 9,
                HXI: '1943',
                QHXI: 9,
                FXI2: null,
                QFXI2: null,
                DXI2: null,
                QDXI2: null,
                HXI2: null,
                QHXI2: null,
                FXI3S: 13.6,
                QFXI3S: 9,
                DXI3S: null,
                QDXI3S: null,
                HXI3S: '1135',
                QHXI3S: 9,
                DRR: null,
                QDRR: null,
            },
            {
                NUM_POSTE: '01014002',
                NOM_USUEL: 'ARBENT',
                LAT: 46.278167,
                LON: 5.669,
                ALTI: 534,
                AAAAMMJJ: new Date('2023-01-02T00:00:00Z'),
                RR: 11.0,
                QRR: 1,
                TN: 8.6,
                QTN: 1,
                HTN: '1746',
                QHTN: 9,
                TX: 14.3,
                QTX: 1,
                HTX: '0846',
                QHTX: 9,
                TM: 11.5,
                QTM: 1,
                TNTXM: 11.5,
                QTNTXM: 1,
                TAMPLI: 5.7,
                QTAMPLI: 1,
                TNSOL: null,
                QTNSOL: null,
                TN50: null,
                QTN50: null,
                DG: 0,
                QDG: 9,
                FFM: 3.0,
                QFFM: 1,
                FF2M: null,
                QFF2M: null,
                FXY: 6.3,
                QFXY: 1,
                DXY: 200,
                QDXY: 1,
                HXY: '1001',
                QHXY: 9,
                FXI: 14.4,
                QFXI: 1,
                DXI: 180,
                QDXI: 1,
                HXI: '0954',
                QHXI: 9,
                FXI2: null,
                QFXI2: null,
                DXI2: null,
                QDXI2: null,
                HXI2: null,
                QHXI2: null,
                FXI3S: 12.0,
                QFXI3S: 9,
                DXI3S: null,
                QDXI3S: null,
                HXI3S: '0955',
                QHXI3S: 9,
                DRR: null,
                QDRR: null,
            },
            {
                NUM_POSTE: '01014002',
                NOM_USUEL: 'ARBENT',
                LAT: 46.278167,
                LON: 5.669,
                ALTI: 534,
                AAAAMMJJ: new Date('2023-01-03T00:00:00Z'),
                RR: 1.1,
                QRR: 9,
                TN: -2.2,
                QTN: 9,
                HTN: '1230',
                QHTN: 9,
                TX: -2.2,
                QTX: 9,
                HTX: '1230',
                QHTX: 9,
                TM: -2.2,
                QTM: 9,
                TNTXM: -2.2,
                QTNTXM: 9,
                TAMPLI: 1.1,
                QTAMPLI: 9,
                TNSOL: -2.2,
                QTNSOL: 9,
                TN50: -2.2,
                QTN50: 9,
                DG: 3,
                QDG: 9,
                FFM: 1.1,
                QFFM: 9,
                FF2M: 1.1,
                QFF2M: 9,
                FXY: 1.1,
                QFXY: 9,
                DXY: 0,
                QDXY: 9,
                HXY: '1230',
                QHXY: 9,
                FXI: 1.1,
                QFXI: 9,
                DXI: 0,
                QDXI: 9,
                HXI: '1230',
                QHXI: 9,
                FXI2: 1.1,
                QFXI2: 9,
                DXI2: 0,
                QDXI2: 9,
                HXI2: '1230',
                QHXI2: 9,
                FXI3S: 1.1,
                QFXI3S: 9,
                DXI3S: 0,
                QDXI3S: 9,
                HXI3S: '1230',
                QHXI3S: 9,
                DRR: 3,
                QDRR: 9,
            },
            {
                NUM_POSTE: '01014002',
                NOM_USUEL: 'ARBENT',
                LAT: 46.278167,
                LON: 5.669,
                ALTI: 534,
                AAAAMMJJ: new Date('2023-01-04T00:00:00Z'),
                RR: null,
                QRR: null,
                TN: null,
                QTN: null,
                HTN: null,
                QHTN: null,
                TX: null,
                QTX: null,
                HTX: null,
                QHTX: null,
                TM: null,
                QTM: null,
                TNTXM: null,
                QTNTXM: null,
                TAMPLI: null,
                QTAMPLI: null,
                TNSOL: null,
                QTNSOL: null,
                TN50: null,
                QTN50: null,
                DG: null,
                QDG: null,
                FFM: null,
                QFFM: null,
                FF2M: null,
                QFF2M: null,
                FXY: null,
                QFXY: null,
                DXY: null,
                QDXY: null,
                HXY: null,
                QHXY: null,
                FXI: null,
                QFXI: null,
                DXI: null,
                QDXI: null,
                HXI: null,
                QHXI: null,
                FXI2: null,
                QFXI2: null,
                DXI2: null,
                QDXI2: null,
                HXI2: null,
                QHXI2: null,
                FXI3S: null,
                QFXI3S: null,
                DXI3S: null,
                QDXI3S: null,
                HXI3S: null,
                QHXI3S: null,
                DRR: null,
                QDRR: null,
            },
        ]);
    });
});
